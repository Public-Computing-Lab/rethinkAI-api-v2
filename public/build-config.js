#!/usr/bin/env node
/**
 * Build Configuration Generator
 * Reads .env file and generates config.js for the webapp
 * Run with: node build-config.js
 */

const fs = require('fs');
const path = require('path');

/**
 * Parse .env file into an object
 */
function loadEnv(envPath = '.env') {
  const env = {};
  
  if (!fs.existsSync(envPath)) {
	console.error('‚ùå .env file not found at:', path.resolve(envPath));
	console.log('üí° Create a .env file based on .env.example');
	return env;
  }
  
  const envFile = fs.readFileSync(envPath, 'utf8');
  
  envFile.split('\n').forEach(line => {
	// Remove whitespace
	line = line.trim();
	
	// Skip empty lines and comments
	if (!line || line.startsWith('#')) return;
	
	// Match KEY=VALUE pattern
	const match = line.match(/^([^=]+)=(.*)$/);
	if (match) {
	  const key = match[1].trim();
	  let value = match[2].trim();
	  
	  // Remove surrounding quotes
	  if ((value.startsWith('"') && value.endsWith('"')) ||
		  (value.startsWith("'") && value.endsWith("'"))) {
		value = value.slice(1, -1);
	  }
	  
	  env[key] = value;
	}
  });
  
  return env;
}

/**
 * Generate config.js from environment variables
 */
function generateConfig() {
  console.log('üîß Building configuration from .env...\n');
  
  // Load environment variables from project root
  const envPath = path.join(__dirname, '..', '.env');
  const env = loadEnv(envPath);
  
  if (Object.keys(env).length === 0) {
	console.error('‚ùå No environment variables loaded');
	process.exit(1);
  }
  
  // Extract only the values needed for the webapp
  const config = {
	baseUrl: env.API_BASE_URL || 'https://boston.ourcommunity.is/api/v2',
	apiKey: env.RETHINKAI_API_KEY || '',
	timeoutMs: parseInt(env.API_TIMEOUT_MS) || 30000,
  };
  
  // Validate required fields
  if (!config.apiKey) {
	console.warn('‚ö†Ô∏è  Warning: RETHINKAI_API_KEY is not set in .env');
  }
  
  // Generate JavaScript file content
  const configJs = `// Auto-generated configuration from .env
// DO NOT EDIT THIS FILE MANUALLY - run 'node build-config.js' to regenerate
// Generated: ${new Date().toISOString()}

window.AppConfig = ${JSON.stringify(config, null, 2)};
`;
  
  // Write to config.js
  const outputPath = path.join(__dirname, 'config.js');
  fs.writeFileSync(outputPath, configJs, 'utf8');
  
  console.log('‚úÖ Configuration generated successfully!');
  console.log('üìÑ Output file:', outputPath);
  console.log('\nüìã Configuration:');
  console.log('   Base URL:', config.baseUrl);
  console.log('   API Key:', config.apiKey ? `${config.apiKey.substring(0, 20)}...` : '(not set)');
  console.log('   Timeout:', config.timeoutMs + 'ms');
  console.log('\nüí° Remember to run this script before deploying!');
}

// Run the generator
try {
  generateConfig();
} catch (error) {
  console.error('‚ùå Error generating config:', error.message);
  process.exit(1);
}